'use strict';

// external imports
const {map, pipe, property} = require('lodash/fp');

// local imports
const {generateSync} = require('./helpers/promise_sync_helpers');
const {getDBEffects} = require('./helpers/db_helpers');
const {joinTwoPaths} = require('./helpers/path_helpers');
const {extractFileBasedPackagesPaths} = require('./helpers/package_json_helpers');

const {setMasterProcessType} = require('./effects/process_meta_effects');
const {getDBType, setJSMemoryDBType} = require('./effects/app_effects');
const {initModulesTraversingProcessQueue} = require('./effects/child_process_queue_effects');
const {executeChildProcessTask} = require('./effects/master_process_effects');
const {readPackageJSON} = require('./effects/fs_effects');
const {writJSONToFile} = require('./effects/fs_effects');

// functions definition

// set `master` type for current process
setMasterProcessType();

// choose `JS memory` database type (nothing special - all data will be stored in memory)
setJSMemoryDBType();

const masterProcess = generateSync(function* () {
    const PATH_TO_FATBACK = '/home/segei/projects/test_fatback/';

    console.log('Open DB connection...');
    const dbType = getDBType();
    const dbConnection = yield getDBEffects(dbType).openConnectionToDB();
    yield getDBEffects(dbType).prepareDatabase(dbConnection);

    const pathsToTraverse = pipe(
        property('dependencies'),
        extractFileBasedPackagesPaths,
        map(joinTwoPaths(PATH_TO_FATBACK))
    )(readPackageJSON(PATH_TO_FATBACK));

    initModulesTraversingProcessQueue(executeChildProcessTask(dbType, dbConnection), pathsToTraverse)
       .then(() => getDBEffects(dbType).exportToJSON(dbConnection))
       .then(exportedJSON => writJSONToFile(`${__dirname}/semver_modules_versions.json`, exportedJSON));


});

// launch master process
masterProcess();

