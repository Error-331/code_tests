'use strict';

// external imports
const {join} = require('path');
const semver = require('semver');

const {isEmpty, stubTrue, equals, cond, curry, trim, split, pipe, identity, reduce, map, filter, complement, chunk, size} = require('lodash/fp');
const jsonfile = require('jsonfile');
const cp = require('child_process');

// local imports
const {generateSync} = require('./helpers/promise_sync_helpers');
const {getDBEffects, getModulesLocationsQueryWrappers} = require('./helpers/db_helpers');

const {getDBType, setJSMemoryDBType} = require('./effects/app_effects');
const {extractAndSaveModuleData} = require('./effects/modules_tree_effects');

const {executeChildProcessTask} = require('./effects/master_process_effects');

// functions definition
const logDirectory =  curry((logPrefix, directoryPath) => {
    console.log(`${logPrefix}${directoryPath}`);
    return directoryPath;
});

const determineMaxVersions = (currentMaxVersion, nextVersion, operator) => pipe(

)(nextVersion);

const isArrayOfOne = usrArray => equals(size(usrArray), 1);
const isArrayOdd = usrArray => equals(size(usrArray) % 2, 1);
const isArrayEven = complement(isArrayOdd);

const combineVersionRangeParts = (versionRanges) => reduce(
    () => {

    },

    [],

    versionRanges
);

const fSpace = curry((currentMaxVersion, versionsRange) => pipe(
    trim,
    split(' '),
    filter(complement(isEmpty)), // to lib
    cond([
        [isArrayOfOne, ([versionRange]) => determineMaxVersions(currentMaxVersion, versionRange, null)],
        [isArrayOdd, () => throw new Error(`Cannot combine version range after 'space split': '${versionsRange}'`)],
        [isArrayEven, pipe(chunk(2), reduce(
            (currentMaxVersion, [operator, version]) => determineMaxVersions(currentMaxVersion, version, operator),
            currentMaxVersion
        ))]
    ]),

)(versionsRange));

const fHypen = curry((currentMaxVersion, versionsRange) => pipe(
    split('-'),
    map(fSpace(currentMaxVersion)),
)(versionsRange));

const f2 = curry((currentMaxVersion, versionsRange) => pipe(
    trim,
    cond([
        [testStr => testStr.includes('-'), fHypen(currentMaxVersion)],
        [testStr => testStr.includes(' '), fSpace(currentMaxVersion)],
        [stubTrue, identity],
    ])
)(versionsRange));

const f1 = (versionsRange) => pipe(
    trim,
    split('||'), // | or || - case
    // check if more then 1 - BIO OR needed else compare versions - generally cond is needed
    reduce(f2, ''),
)(versionsRange);

console.log(f1('  1.2.3 - 2.3.4 ||   >=3.5.6  || 2.5.6 -   2.6.0 || >=   1.2.3 <    2.4.0 '));

return true;

// module implementation
const pathToRootNodeModules1 = '/home/segei/projects/code_tests';
//const pathToRootNodeModules = '/home/segei/Downloads';
 //const pathToRootNodeModules = '/home/brightsign/projects/fatback/';
const pathToRootNodeModules2 = '/home/brightsign/projects/fatback/bsCore';
// const pathToRootNodeModules = '/home/brightsign/projects/fatback/node_modules/bacon/node_modules/@brightsign/ba-dialog-ui/node_modules/@brightsign/ba-context-model/node_modules/@brightsign/bs-playlist-dm/node_modules/@brightsign/bscore/';


setJSMemoryDBType();

const b = generateSync(function* () {


    console.log('Open DB connection...');
    const dbType = getDBType();
    const dbConnection = yield getDBEffects(dbType).openConnectionToDB();
    yield getDBEffects(dbType).prepareDatabase(dbConnection);


    const n = cp.fork(`${__dirname}/child_proc_test.js`);

    n.on('message', (childMessage) => {
        console.log('PARENT got message:', childMessage);

        const {name, type, data} = childMessage;

        const taskPromise = executeChildProcessTask(dbType, dbConnection, type, data);

        taskPromise.then((taskResult) => {
            n.send({name, data: taskResult})
        })
    });


    /*const resultingJSON = yield getDBEffects(dbType).exportToJSON(dbConnection);
    console.log(resultingJSON);

    jsonfile.writeFile('deps.json', resultingJSON, { spaces: 2 }, function (err) {
        if (err) console.error(err)
    });*/

  /*  console.log('Closing DB connection...');
    yield getDBEffects(dbType).closeConnectionToDB(dbConnection);*/
});

b();

