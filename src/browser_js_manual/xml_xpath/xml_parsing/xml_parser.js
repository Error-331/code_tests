const xmlString1 = `<?xml version="1.0" encoding="UTF-8"?>
<nsResponse>
    <record perm="4"
            fields="_eml_nkey_,_multibtnstate_,selectedtab,nsapiPI,nsapiSR,nsapiVF,nsapiFC,nsapiPS,nsapiVI,nsapiVD,nsapiPD,nsapiVL,nsapiRC,nsapiLI,nsapiLC,nsapiCT,nsbrowserenv,type,id,externalid,whence,customwhence,entryformquerystring,_csrf">
        <_csrf>
            rnA1ZPSpaaRpUyuECiIbxvzwAblQQY69oWTgZpx0NCFYnX576RcusI4MvQwdgUL5biWrZEtpptsA2oAy7d-EawVzBzEiF4I1JLEorsvKQesed-iBgmplO2g_6fDmV3AAUyTf9ROmmhjT3q0YY8AwadGCCUQQybHqz39H_khWmww=
        </_csrf>
        <_eml_nkey_>3293628_SB1~143898~3~N</_eml_nkey_>
        <entryformquerystring>sales=T&amp;xml=T</entryformquerystring>
        <nsapiCT>1648322240073</nsapiCT>
        <type>territory</type>
        <machine name="territory" type="list" fields="territoryseqnum,id,urlid,name,url,descr,ct,sales">
            <line>
                <ct>1</ct>
                <descr>John's Territory</descr>
                <id>11</id>
                <name>BrightSign US New York Sales Territory</name>
                <sales>T</sales>
                <territoryseqnum>1</territoryseqnum>
                <url>/app/crm/sales/salesterritory.nl</url>
                <urlid>11</urlid>
            </line>
            <line>
                <ct>1</ct>
                <descr>Kaleo's Territory</descr>
                <id>1</id>
                <name>BrightSign US Southwest Sales Territory</name>
                <sales>T</sales>
                <territoryseqnum>2</territoryseqnum>
                <url>/app/crm/sales/salesterritory.nl</url>
                <urlid>1</urlid>
            </line>
            <line>
                <ct>1</ct>
                <descr>Matt's Territory</descr>
                <id>13</id>
                <name>BrightSign US Northwest Territory</name>
                <sales>T</sales>
                <territoryseqnum>4</territoryseqnum>
                <url>/app/crm/sales/salesterritory.nl</url>
                <urlid>13</urlid>
            </line>
            <line>
                <ct>1</ct>
                <descr>Misty's Territory</descr>
                <id>15</id>
                <name>BrightSign US Mid-Atlantic &amp; Federal Government</name>
                <sales>T</sales>
                <territoryseqnum>6</territoryseqnum>
                <url>/app/crm/sales/salesterritory.nl</url>
                <urlid>15</urlid>
            </line>
            <line>
                <ct>1</ct>
                <descr>Tim's Territory</descr>
                <id>5</id>
                <name>BrightSign US Ohio Valley Territory</name>
                <sales>T</sales>
                <territoryseqnum>7</territoryseqnum>
                <url>/app/crm/sales/salesterritory.nl</url>
                <urlid>5</urlid>
            </line>
            <line>
                <ct>1</ct>
                <descr>Linda's Territory</descr>
                <id>16</id>
                <name>BrightSign US TOLA Territory</name>
                <sales>T</sales>
                <territoryseqnum>8</territoryseqnum>
                <url>/app/crm/sales/salesterritory.nl</url>
                <urlid>16</urlid>
            </line>
            <line>
                <ct>1</ct>
                <descr>William's Territory</descr>
                <id>14</id>
                <name>BrightSign Int'l Territory - East Asia and Pacific</name>
                <sales>T</sales>
                <territoryseqnum>9</territoryseqnum>
                <url>/app/crm/sales/salesterritory.nl</url>
                <urlid>14</urlid>
            </line>
            <line>
                <ct>1</ct>
                <descr>Paul's Territory</descr>
                <id>20</id>
                <name>BrightSign International Territory - UK</name>
                <sales>T</sales>
                <territoryseqnum>10</territoryseqnum>
                <url>/app/crm/sales/salesterritory.nl</url>
                <urlid>20</urlid>
            </line>
            <line>
                <ct>1</ct>
                <descr>Pierre's Territory</descr>
                <id>8</id>
                <name>BrightSign International Territory - Wordwide</name>
                <sales>T</sales>
                <territoryseqnum>11</territoryseqnum>
                <url>/app/crm/sales/salesterritory.nl</url>
                <urlid>8</urlid>
            </line>
            <line>
                <ct>0</ct>
                <id>9</id>
                <name>Test territory Assignment</name>
                <sales>T</sales>
                <territoryseqnum>12</territoryseqnum>
                <url>/app/crm/sales/salesterritory.nl</url>
                <urlid>9</urlid>
            </line>
            <line>
                <ct>1</ct>
                <descr>Southeast territory</descr>
                <id>10</id>
                <name>Brightsign: Sales Territories Carribean Islands</name>
                <sales>T</sales>
                <territoryseqnum>13</territoryseqnum>
                <url>/app/crm/sales/salesterritory.nl</url>
                <urlid>10</urlid>
            </line>
            <line>
                <ct>0</ct>
                <descr>Ray's Territory</descr>
                <id>12</id>
                <name>BrightSign Central/South America Territory</name>
                <sales>T</sales>
                <territoryseqnum>14</territoryseqnum>
                <url>/app/crm/sales/salesterritory.nl</url>
                <urlid>12</urlid>
            </line>
            <line>
                <ct>1</ct>
                <descr>Dave's Territory</descr>
                <id>17</id>
                <name>BrightSign US Mid-West Territory</name>
                <sales>T</sales>
                <territoryseqnum>15</territoryseqnum>
                <url>/app/crm/sales/salesterritory.nl</url>
                <urlid>17</urlid>
            </line>
            <line>
                <ct>0</ct>
                <id>-5</id>
                <name>Default Round-Robin</name>
                <sales>T</sales>
                <territoryseqnum>1000000</territoryseqnum>
                <url>/app/crm/sales/salesterritory.nl</url>
                <urlid>-5</urlid>
            </line>
        </machine>
    </record>
</nsResponse>
`;

const xmlString2 = `<?xml version="1.0" encoding="UTF-8"?>
<nsResponse>
    <record id="17" perm="4"
            fields="_eml_nkey_,_multibtnstate_,selectedtab,nsapiPI,nsapiSR,nsapiVF,nsapiFC,nsapiPS,nsapiVI,nsapiVD,nsapiPD,nsapiVL,nsapiRC,nsapiLI,nsapiLC,nsapiCT,nsbrowserenv,type,id,externalid,whence,customwhence,entryformquerystring,_csrf,name,descr,matchall,matchall,inactive">
        <_csrf>
            rnA1ZPSpaaRpUyuECiIbxvzwAblQQY69oWTgZpx0NCFYnX576RcusI4MvQwdgUL5biWrZEtpptsA2oAy7d-EawVzBzEiF4I1JLEorsvKQesed-iBgmplO2g_6fDmV3AAUyTf9ROmmhjT3q0YY8AwadGCCUQQybHqz39H_khWmww=
        </_csrf>
        <_eml_nkey_>3293628_SB1~143898~3~N</_eml_nkey_>
        <descr>Dave's Territory</descr>
        <entryformquerystring>id=17&amp;xml=T</entryformquerystring>
        <id>17</id>
        <inactive>F</inactive>
        <matchall>T</matchall>
        <name>BrightSign US Mid-West Territory</name>
        <nsapiCT>1648325349471</nsapiCT>
        <type>salesterritory</type>
        <whence>/app/crm/common/automation/territorymanager.nl?sales=T&amp;scrollid=17</whence>
        <machine name="rules" type="edit" fields="rulekey,ruleurl,territoryrule,field,numsubrules,ruledescr">
            <line>
                <field>State</field>
                <numsubrules>0</numsubrules>
                <ruledescr>Dave's Territory</ruledescr>
                <rulekey>38</rulekey>
                <ruleurl>/app/crm/sales/customerfieldrule.nl</ruleurl>
                <territoryrule>38</territoryrule>
            </line>
        </machine>
        <machine name="entityterritorymap" type="edit" fields="empkey,empurl,empurlperm,entity,seqnum,phone,email">
            <line>
                <email>dmadera@brightsign.biz</email>
                <empkey>172503</empkey>
                <empurl>/app/common/entity/employee.nl</empurl>
                <empurlperm>LIST_EMPLOYEE</empurlperm>
                <entity>172503</entity>
                <seqnum>1</seqnum>
            </line>
        </machine>
    </record>
</nsResponse>
`;

function prepareJSONDataDummyTerritories() {
  const jsonData = {};
  jsonData.regions = [];

  return jsonData;
}

function parseTerritoriesXMLWithDOMParser(xmlString) {
  const domParser = new DOMParser();
  const xmlDocument = domParser.parseFromString(xmlString, 'text/xml');
  const $machine = xmlDocument.querySelector('machine');

  const jsonData = prepareJSONDataDummyTerritories();

  for (const $line of $machine.children) {
    const lineData = {};
    for (const $lineChild of $line.children) {
      lineData[$lineChild.nodeName] = $lineChild.textContent;
    }

    jsonData.regions.push(lineData)
  }

  return jsonData;
}

function extractChildNodesValues(xmlDocument, $parentNode, nodeOptions = []) {
  const resultObj = {};

  for (const nodeOption of nodeOptions) {
    if (typeof nodeOption === 'object') {

      switch(nodeOption.type) {
        case XPathResult.STRING_TYPE:
          resultObj[nodeOption.name] = xmlDocument.evaluate(nodeOption.name, $parentNode, null, XPathResult.STRING_TYPE, null).stringValue;
          break;

        case XPathResult.NUMBER_TYPE:
          resultObj[nodeOption.name] = xmlDocument.evaluate(nodeOption.name, $parentNode, null, XPathResult.NUMBER_TYPE, null).numberValue;
          break;

        default:
          resultObj[nodeOption] = xmlDocument.evaluate(nodeOption.name, $parentNode, null, XPathResult.STRING_TYPE, null).stringValue;
          break;
      }
    } else {
      resultObj[nodeOption] = xmlDocument.evaluate(nodeOption, $parentNode, null, XPathResult.STRING_TYPE, null).stringValue;
    }
  }

  return resultObj;
}

function parseTerritoriesXMLWithXPath(xmlString) {
  const domParser = new DOMParser();
  const xmlDocument = domParser.parseFromString(xmlString, 'text/xml');
  const $machine = xmlDocument.evaluate( '//machine/line', xmlDocument, null, XPathResult.ANY_TYPE, null);

  const jsonData = prepareJSONDataDummyTerritories();
  let $line;

  do {
    $line = $machine.iterateNext();

    if ($line === null) {
      break;
    }

    const nodeOptions = ['ct', 'descr', {name: 'id', type: XPathResult.NUMBER_TYPE}, 'name', 'sales', 'territoryseqnum', 'url', 'urlid'];
    jsonData.regions.push(extractChildNodesValues(xmlDocument, $line, nodeOptions));


  } while($line)

  return jsonData;
}

function parseSalesFromTerritoryXMLWithXPath(xmlString) {
  const domParser = new DOMParser();
  const xmlDocument = domParser.parseFromString(xmlString, 'text/xml');
  const $machine = xmlDocument.evaluate( '//machine[@name="entityterritorymap"]/line', xmlDocument, null, XPathResult.ANY_TYPE, null);

  let $line;

  do {
    $line = $machine.iterateNext();

    if ($line === null) {
      break;
    }

    const nodeOptions = [
      'email',
      { name: 'empkey', type: XPathResult.NUMBER_TYPE },
      { name: 'entity', type: XPathResult.NUMBER_TYPE }
    ];

    return extractChildNodesValues(xmlDocument, $line, nodeOptions)

  } while($line)
}

console.log(parseSalesFromTerritoryXMLWithXPath(xmlString2));

